---
- name: "authorized_key: Get list of users"
  getent:
    database: passwd

- name: "authorized_key: Debug"
  vars:
    msg: |
         fp_authorized_key_fail [ {{ fp_authorized_key_fail }} ]
         fp_authorized_key
         {{ fp_authorized_key | to_nice_yaml }}
         getent_passwd keys
         {{ getent_passwd.keys() | to_yaml }}
  debug:
    msg: "{{ msg.split('\n') }}"
  when: fp_debug|bool

- name: "authorized_key: Configure authorized keys"
  authorized_key:
    user: "{{ item.user }}"
    key: "{{ item.key }}"
    exclusive: "{{ item.exclusive|default(omit) }}"
    comment: "{{ item.comment|default(omit) }}"
    follow: "{{ item.follow|default(omit) }}"
    key_options: "{{ item.key_iptions|default(omit) }}"
    manage_dir: "{{ item.manage_dir|default(omit) }}"
    path: "{{ item.path|default(omit) }}"
    state: "{{ item.state|default(omit) }}"
    validate_certs: "{{ item.validate_certs|default(omit) }}"
  loop: "{{ fp_authorized_key }}"
  when: fp_authorized_key_fail|bool
        or item.user in getent_passwd.keys()

# EOF
...
