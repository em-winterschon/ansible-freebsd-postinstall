---

- name: Get current config
  block:

    - name: "freebsd-update: Read /etc/freebsd-update.conf"
      ansible.builtin.shell:
        cmd: 'freebsd-update showconfig | grep .*=.*'
      register: out
      changed_when: false

    - name: "freebsd-update: Create fp_freebsd_update_conf"
      ansible.builtin.set_fact:
        fp_freebsd_update_conf: "{{ out.stdout|community.general.jc('ini') }}"

    - name: "freebsd-update: Debug fp_freebsd_update_conf"
      ansible.builtin.debug:
        var: fp_freebsd_update_conf
      when: fp_freebsd_update_debug|bool

  tags:
    - fp_freebsd_update_getconf
    - fp_freebsd_update_debug
    - fp_freebsd_update_protect_keyprint
    - fp_freebsd_update_sanity

- name: "freebsd-update: Protect trusted keyprint"
  ansible.builtin.assert:
    quiet: "{{ fp_freebsd_update_sanity_quiet }}"
    that:
      fp_freebsd_update_conf.keyprint == fp_freebsd_update_KeyPrint
    fail_msg: '[ERR] Changing KeyPrint not allowed.'
    success_msg: '[OK]  KeyPrint will not change.'
  when: fp_freebsd_update_protect_KeyPrint|bool
  tags: fp_freebsd_update_protect_keyprint

- name: Sanity
  block:

    - name: "freebsd-update: Sanity trusted keyprint"
      ansible.builtin.assert:
        quiet: "{{ fp_freebsd_update_sanity_quiet }}"
        that:
          fp_freebsd_update_KeyPrint is regex('^[0-9a-fA-F]{64}$')
        fail_msg: '[ERR] KeyPrint not valid.'
        success_msg: '[OK]  KeyPrint is valid.'
      when: fp_freebsd_update_sanity_KeyPrint|bool

  when: fp_freebsd_update_sanity|bool
  tags: fp_freebsd_update_sanity

- name: "freebsd-update: Backup origin /etc/freebsd-update.conf"
  ansible.builtin.command:
    cmd: cp /etc/freebsd-update.conf /etc/freebsd-update.conf.orig
    creates: /etc/freebsd-update.conf.orig
  when: fp_freebsd_update_conf_orig|bool
  tags: fp_freebsd_update_conf_orig

- name: "freebsd-update: Create /etc/freebsd-update.conf from template"
  ansible.builtin.template:
    src: "{{ fp_freebsd_update_conf_template }}"
    dest: /etc/freebsd-update.conf
    owner: root
    group: wheel
    mode: '0644'
    backup: "{{ fp_backup }}"
  tags: fp_freebsd_update_conf

# EOF
...
